<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/app.css" />
		<link href="../../css/mui.imageviewer.css" rel="stylesheet" />
		<style>
			html,
			body {
				height: 100%;
				margin: 0px;
				padding: 0px;
				overflow: hidden;
				-webkit-touch-callout: none;
				-webkit-user-select: none;
			}
			
			footer {
				position: fixed;
				width: 100%;
				height: 50px;
				min-height: 50px;
				border-top: solid 1px #bbb;
				left: 0px;
				bottom: 0px;
				overflow: hidden;
				padding: 0px 50px;
				background-color: #fafafa;
			}
			
			.footer-left {
				position: absolute;
				width: 50px;
				height: 50px;
				left: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 4px;
			}
			
			.footer-right {
				position: absolute;
				width: 50px;
				height: 50px;
				right: 0px;
				bottom: 0px;
				text-align: center;
				vertical-align: middle;
				line-height: 100%;
				padding: 12px 5px;
				display: inline-block;
			}
			
			.footer-center {
				height: 100%;
				padding: 5px 0px;
			}
			
			.footer-center [class*=input] {
				width: 100%;
				height: 100%;
				border-radius: 5px;
			}
			
			.footer-center .input-text {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				line-height: 18px !important;
				font-family: verdana !important;
				overflow: hidden;
			}
			
			.footer-center .input-sound {
				background-color: #eee;
			}
			
			.mui-content {
				height: 100%;
				padding: 44px 0px 50px 0px;
				overflow: auto;
				background-color: #eaeaea;
			}
			
			#msg-list {
				height: 100%;
				overflow: auto;
				-webkit-overflow-scrolling: touch;
			}
			
			.msg-item {
				padding: 8px;
				clear: both;
			}
			
			.msg-item .mui-item-clear {
				clear: both;
			}
			
			.msg-item .msg-user {
				width: 38px;
				height: 38px;
				border: solid 1px #d3d3d3;
				display: inline-block;
				background: #fff;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				padding: 3px;
				color: #ddd;
			}
			
			.msg-item .msg-user-img {
				width: 38px;
				height: 38px;
				display: inline-block;
				border-radius: 3px;
				vertical-align: top;
				text-align: center;
				float: left;
				color: #ddd;
			}
			
			.msg-item .msg-content {
				display: inline-block;
				border-radius: 5px;
				border: solid 1px #d3d3d3;
				background-color: #FFFFFF;
				color: #333;
				padding: 8px;
				vertical-align: top;
				font-size: 15px;
				position: relative;
				margin: 0px 8px;
				max-width: 75%;
				min-width: 35px;
				float: left;
			}
			
			.msg-item .msg-content .msg-content-inner {
				overflow-x: hidden;
			}
			
			.msg-item .msg-content .msg-content-arrow {
				position: absolute;
				border: solid 1px #d3d3d3;
				border-right: none;
				border-top: none;
				background-color: #FFFFFF;
				width: 10px;
				height: 10px;
				left: -5px;
				top: 12px;
				-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);
			}
			
			.msg-item-self .msg-user,
			.msg-item-self .msg-content {
				float: right;
			}
			
			.msg-item-self .msg-content .msg-content-arrow {
				left: auto;
				right: -5px;
				-webkit-transform: rotateZ(225deg);
				transform: rotateZ(225deg);
			}
			
			.msg-item-self .msg-content,
			.msg-item-self .msg-content .msg-content-arrow {
				background-color: #4CD964;
				color: #fff;
				border-color: #2AC845;
			}
			
			footer .mui-icon {
				color: #000;
			}
			
			footer .mui-icon:active {
				color: #007AFF !important;
			}
			
			footer .mui-icon-paperplane:before {
				content: "发送";
			}
			
			footer .mui-icon-paperplane {
				/*-webkit-transform: rotateZ(45deg);
				transform: rotateZ(45deg);*/
				font-size: 16px;
				word-break: keep-all;
				line-height: 100%;
				padding-top: 6px;
				color: rgba(0, 135, 250, 1);
			}
			
			#msg-sound {
				-webkit-user-select: none !important;
				user-select: none !important;
			}
			
			.rprogress {
				position: absolute;
				left: 50%;
				top: 50%;
				width: 140px;
				height: 140px;
				margin-left: -70px;
				margin-top: -70px;
				background-image: url(../../images/arecord.png);
				background-repeat: no-repeat;
				background-position: center center;
				background-size: 30px 30px;
				background-color: rgba(0, 0, 0, 0.7);
				border-radius: 5px;
				display: none;
				-webkit-transition: .15s;
			}
			
			.rschedule {
				background-color: rgba(0, 0, 0, 0);
				border: 5px solid rgba(0, 183, 229, 0.9);
				opacity: .9;
				border-left: 5px solid rgba(0, 0, 0, 0);
				border-right: 5px solid rgba(0, 0, 0, 0);
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				-webkit-animation: spin 1s infinite linear;
				animation: spin 1s infinite linear;
			}
			
			.r-sigh {
				display: none;
				border-radius: 50px;
				box-shadow: 0 0 15px #2187e7;
				width: 46px;
				height: 46px;
				position: absolute;
				left: 50%;
				top: 50%;
				margin-left: -23px;
				margin-top: -23px;
				text-align: center;
				line-height: 46px;
				font-size: 40px;
				font-weight: bold;
				color: #2187e7;
			}
			
			.rprogress-sigh {
				background-image: none !important;
			}
			
			.rprogress-sigh .rschedule {
				display: none !important;
			}
			
			.rprogress-sigh .r-sigh {
				display: block !important;
			}
			
			.rsalert {
				font-size: 12px;
				color: #bbb;
				text-align: center;
				position: absolute;
				border-radius: 5px;
				width: 130px;
				margin: 5px 5px;
				padding: 5px;
				left: 0px;
				bottom: 0px;
			}
			
			@-webkit-keyframes spin {
				0% {
					-webkit-transform: rotate(0deg);
				}
				100% {
					-webkit-transform: rotate(360deg);
				}
			}
			
			@keyframes spin {
				0% {
					transform: rotate(0deg);
				}
				100% {
					transform: rotate(360deg);
				}
			}
			
			#h {
				background: #fff;
				border: solid 1px #ddd;
				padding: 10px !important;
				font-size: 16px !important;
				font-family: verdana !important;
				line-height: 18px !important;
				overflow: visible;
				position: absolute;
				left: -1000px;
				right: 0px;
				word-break: break-all;
				word-wrap: break-word;
			}
			
			.cancel {
				background-color: darkred;
			}
		</style>
	</head>

	<body contextmenu="return false;">
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" id="titleName"></h1>
		</header>
		<pre id='h'></pre>
		<script id='msg-template' type="text/template">

			<% for(var i in record){ var item=record[i]; %>
			<div class="msg-item <%= (item.sender=='self'?' msg-item-self':'') %>" msg-type='<%=(item.type)%>' msg-content='<%=(item.content)%>'>
				<% if(item.sender=='self' ) { %>
				<i class="msg-user mui-icon mui-icon-person"></i>
				<% } else { %>
				<img class="msg-user-img" src="../../images/logo.png" alt="" />
				<% } %>
				<div class="msg-content">
					<div class="msg-content-inner">
						<% if(item.type=='text' ) { %>
						<%=( item.content|| '&nbsp;&nbsp;') %>
						<% } else if(item.type=='image' ) { %>
						<img class="msg-content-image" src="<%=(item.content)%>" style="max-width: 100px;" />
						<% } else if(item.type=='sound' ) { %>
						<span class="mui-icon mui-icon-mic" style="font-size: 18px;font-weight: bold;"></span>
						<span class="play-state">点击播放</span>
						<% } %>
					</div>
					<div class="msg-content-arrow"></div>
				</div>
				<div class="mui-item-clear"></div>
			</div>
			<% } %>
		</script>
		<div class="mui-content">
			<div id='msg-list'>
			</div>
		</div>
		<footer>
			<!--<div class="footer-left">
				<i id='msg-image' class="mui-icon mui-icon-camera" style="font-size: 28px;"></i>
			</div>-->
			<div class="footer-center">
				<textarea id='msg-text' type="text" class='input-text'></textarea>
				<!--<button id='msg-sound' type="button" class='input-sound' style="display: none;">按住说话</button>-->
			</div>
			<label for="" class="footer-right">
				<i id='msg-type' class="mui-icon mui-icon-paperplane"></i>
			</label>
		</footer>
		<div id='sound-alert' class="rprogress">
			<div class="rschedule"></div>
			<div class="r-sigh">!</div>
			<div id="audio_tips" class="rsalert">手指上滑，取消发送</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.imageViewer.js"></script>
		<script src="../../js/arttmpl.js"></script>
		<script type="text/javascript" charset="utf-8">
			document.getElementById('titleName').innerText = localStorage.DNAME;
			/*----------------------------------------------------------------------------------------------------*/
			/**
			 * 打开数据库
			 */
			var db = openDatabase('fjhDB', '1.0', 'fjhDB', 2 * 1024 * 1024);
			db.transaction(function(context) {
				/**
				 * 判断数据了是否存在 不存在则创建
				 */
				context.executeSql('CREATE TABLE IF NOT EXISTS chatDetailTable (id unique,doctorId,rORl,messageContent,messageTime)', [], function(tx, result) {
						//alert('创建chatListTable表成功');
					},
					function(tx, error) {
						//	alert('创建chatListTable表失败:' + error.message);
					});
			});
			//			db.transaction(function(context) {
			//					context.executeSql('DELETE FROM chatDetailTable ', []);
			//				});
			db.transaction(function(context2) {
				context2.executeSql('SELECT * FROM chatDetailTable where doctorId=? ORDER BY id DESC limit 0,50', [localStorage.DID],
					function(tx, result2) {
						if(result2.rows.length > 0) {
							for(var i = 0; i < result2.rows.length; i++) {
								if(result2.rows.item(i).rORl=="msg-item-self"){
									document.getElementById("msg-list").innerHTML = "<div class=\"msg-item " + result2.rows.item(i).rORl + "\" msg-type=\"text\" msg-content=\"" + result2.rows.item(i).messageContent + "\">\n" +
									" 						<i><img src=\""+localStorage.patientImgPath+"\" class=\"msg-user mui-icon mui-icon-person\" /></i>\n" +
									" 					<div class=\"msg-content\">\n" +
									" 						<div class=\"msg-content-inner\"><p>"+result2.rows.item(i).messageTime+"</p>\n" +
									" 								" + result2.rows.item(i).messageContent + "\n" +
									" 						</div>\n" +
									" 						<div class=\"msg-content-arrow\"></div>\n" +
									" 					</div>\n" +
									" 					<div class=\"mui-item-clear\"></div>\n" +
									" 				</div>" + document.getElementById("msg-list").innerHTML;
								}else{
								document.getElementById("msg-list").innerHTML = "<div class=\"msg-item " + result2.rows.item(i).rORl + "\" msg-type=\"text\" msg-content=\"" + result2.rows.item(i).messageContent + "\">\n" +
									" 						<i><img src=\""+imgPath+localStorage.DImgPath+"\" class=\"msg-user mui-icon mui-icon-person\" /></i>\n" +
									" 					<div class=\"msg-content\">\n" +
									" 						<div class=\"msg-content-inner\"><p>"+result2.rows.item(i).messageTime+"</p>\n" +
									" 								" + result2.rows.item(i).messageContent + "\n" +
									" 						</div>\n" +
									" 						<div class=\"msg-content-arrow\"></div>\n" +
									" 					</div>\n" +
									" 					<div class=\"mui-item-clear\"></div>\n" +
									" 				</div>" + document.getElementById("msg-list").innerHTML;	
								}
								
							}
						} else {}
					}
				)

			});
			/*----------------------------------------------------------------------------------------------------*/
			(function($, doc) {
				var MIN_SOUND_TIME = 800;
				$.init({
					gestureConfig: {
						tap: true, //默认为true
						doubletap: true, //默认为false
						longtap: true, //默认为false
						swipe: true, //默认为true
						drag: true, //默认为true
						hold: true, //默认为false，不监听
						release: true //默认为false，不监听
					}
				});
				template.config('escape', false);
				//$.plusReady=function(fn){fn();};
				$.plusReady(function() {
					plus.webview.currentWebview().setStyle({
						softinputMode: "adjustResize"
					});
					var showKeyboard = function() {
						if($.os.ios) {
							var webView = plus.webview.currentWebview().nativeInstanceObject();
							webView.plusCallMethod({
								"setKeyboardDisplayRequiresUserAction": false
							});
						} else {
							var Context = plus.android.importClass("android.content.Context");
							var InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
							var main = plus.android.runtimeMainActivity();
							var imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
							imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
							//var view = ((ViewGroup)main.findViewById(android.R.id.content)).getChildAt(0);
							imm.showSoftInput(main.getWindow().getDecorView(), InputMethodManager.SHOW_IMPLICIT);
							//alert("ll");
						}
					};
					var record = [];
					var ui = {
						body: doc.querySelector('body'),
						footer: doc.querySelector('footer'),
						footerRight: doc.querySelector('.footer-right'),
						footerLeft: doc.querySelector('.footer-left'),
						btnMsgType: doc.querySelector('#msg-type'),
						boxMsgText: doc.querySelector('#msg-text'),
						boxMsgSound: doc.querySelector('#msg-sound'),
						btnMsgImage: doc.querySelector('#msg-image'),
						areaMsgList: doc.querySelector('#msg-list'),
						boxSoundAlert: doc.querySelector('#sound-alert'),
						h: doc.querySelector('#h'),
						content: doc.querySelector('.mui-content')
					};
					ui.h.style.width = ui.boxMsgText.offsetWidth + 'px';
					//alert(ui.boxMsgText.offsetWidth );
					var footerPadding = ui.footer.offsetHeight - ui.boxMsgText.offsetHeight;
					var msgItemTap = function(msgItem, event) {
						var msgType = msgItem.getAttribute('msg-type');
						var msgContent = msgItem.getAttribute('msg-content')
					};
					var imageViewer = new $.ImageViewer('.msg-content-image', {
						dbl: false
					});
					var bindMsgList = function() {
						//绑定数据:
						/*tp.bind({
							template: 'msg-template',
							element: 'msg-list',
							model: record
						});*/
						ui.areaMsgList.innerHTML = template('msg-template', {
							"record": record
						});
						var msgItems = ui.areaMsgList.querySelectorAll('.msg-item');
						[].forEach.call(msgItems, function(item, index) {
							item.addEventListener('tap', function(event) {
								msgItemTap(item, event);
							}, false);
						});
						imageViewer.findAllImage();
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					};
					//					bindMsgList();
					window.addEventListener('resize', function() {
						ui.areaMsgList.scrollTop = ui.areaMsgList.scrollHeight + ui.areaMsgList.offsetHeight;
					}, false);

					var send = function(msg) {
						//lalala 发送消息请求服务器
						//getChatDetail();
						saveChatDetail(msg.content);
						document.getElementById("msg-list").innerHTML += "<div class=\"msg-item  msg-item-self\" msg-type=\"text\" msg-content=\"" + msg.content + "\">\n" +
							" 						<i><img src=\""+localStorage.patientImgPath+"\" class=\"msg-user mui-icon mui-icon-person\" /></i>\n" +
							" 					<div class=\"msg-content\">\n" +
							" 						<div class=\"msg-content-inner\"><p>"+new Date().Format("yyyy-MM-dd hh:mm:ss")+"</p>\n" +
							" 								" + msg.content + "\n" +
							" 						</div>\n" +
							" 						<div class=\"msg-content-arrow\"></div>\n" +
							" 					</div>\n" +
							" 					<div class=\"mui-item-clear\"></div>\n" +
							" 				</div>";
						document.getElementById("msg-text").value = '';
						//						------------塞入本地-----------------------------------------------
						db.transaction(function(context3) {
								context3.executeSql('select max(id) mid from chatDetailTable', [],
									function(tx, result) {
										var id = (result.rows.item(0).mid) ? result.rows.item(0).mid : 0;
										console.log(id);
										context3.executeSql('INSERT INTO chatDetailTable (id,doctorId,rORl,messageContent,messageTime) VALUES (?,?,?,?,?)', [(id + 1), localStorage.DID, 'msg-item-self', msg.content, new Date().Format("yyyy-MM-dd hh:mm:ss")],
											function(tx, result) {
												console.log("成功插入数据");
											},
											function(tx, error) {
												console.log("插入数据失败");
											}
										);
									},
									function(tx, error) {
										console.log("查询最大Id值失败");
									}
								);
							})
						
							//						-----------------------------------------------------------
						doctorPushToPatientCid(msg.content);
					};
					var toRobot = function(info) {
						document.getElementById("msg-list").innerHTML += "<div class=\"msg-item\" msg-type=\"text\" msg-content=\"" + info + "\">\n" +
							" 						<i><img src=\""+imgPath+localStorage.DImgPath+"\" class=\"msg-user mui-icon mui-icon-person\" /></i>\n" +
							" 					<div class=\"msg-content\">\n" +
							" 						<div class=\"msg-content-inner\"><p>"+new Date().Format("yyyy-MM-dd hh:mm:ss")+"</p>\n" +
							" 								" + info + "\n" +
							" 						</div>\n" +
							" 						<div class=\"msg-content-arrow\"></div>\n" +
							" 					</div>\n" +
							" 					<div class=\"mui-item-clear\"></div>\n" +
							" 				</div>";
						//						//						------------塞入本地-----------------------------------------------
						db.transaction(function(context4) {
								context4.executeSql('select max(id) mid from chatDetailTable', [],
									function(tx, result) {
										var id = (result.rows.item(0).mid) ? result.rows.item(0).mid : 0;
										console.log(id);
										context4.executeSql('INSERT INTO chatDetailTable (id,doctorId,rORl,messageContent,messageTime) VALUES (?,?,?,?,?)', [(id + 1), localStorage.DID, ' ', info, new Date().Format("yyyy-MM-dd hh:mm:ss")],
											function(tx, result) {
												console.log("成功插入数据");
											},
											function(tx, error) {
												console.log("插入数据失败");
											}
										);
									},
									function(tx, error) {
										console.log("查询最大Id值失败");
									}
								);
							})
							//						-----------------------------------------------------------
					};
					//					推送消息给医生
					var doctorPushToPatientCid = function(info2) {
						mui.ajax(ajaxUrl + '/chatPush_patientPushToDoctorCid.action?doctorId=' + localStorage.DID + '&patientId=' + localStorage.patientId + '&patientName=' + localStorage.patientName + '&pathImg=' + localStorage.patientImgPath + '&context=' + info2, {
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							//async: false, //同步
							success: function(data) {}
						})
					};
					//从服务器获取消息
					var getChatDetail = function() {
						var doctorID = localStorage.doctorID;
						var patientID = localStorage.patientID;
						mui.ajax(ajaxUrl + '/chat_getChatDetail.action?receiveId=P' + localStorage.patientId + '&sendId=D' + localStorage.DID, {
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							async: false, //同步
							success: function(data) {
								if(data.length == 0) //数据为空时什么都不执行  
								{} else {
									for(var n = 0; n < data.length; n++) {
										//							alert(data[n][2]);
										toRobot(data[n][2]);

									}
								}
							}
						})
					};
					getChatDetail();
					var saveChatDetail = function(messageContent) {
						mui.ajax(ajaxUrl + '/chat_saveChatForPatient.action?receiveId=' + localStorage.DID + '&sendId=' + localStorage.patientId + '&messageContent=' + messageContent, {
							dataType: 'json', //服务器返回json格式数据
							type: 'post', //HTTP请求类型
							async: false, //同步
							success: function(data) {}
						})
					};
					/*					var toRobot = function(info) {
											var apiUrl = 'http://www.tuling123.com/openapi/api';
											$.getJSON(apiUrl, {
												"key": 'acfbca724ea1b5db96d2eef88ce677dc',
												"info": info,
												"userid": plus.device.uuid
											}, function(data) {
					//							alert(JSON.stringify(data));
												record.push({
													sender: 'zs',
													type: 'text',
													content: data.text
												});
												bindMsgList();
											});
										};*/

					function msgTextFocus() {
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 150);
					}
					//解决长按“发送”按钮，导致键盘关闭的问题；
					ui.footerRight.addEventListener('touchstart', function(event) {
						if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							msgTextFocus();
							event.preventDefault();
						}
					});
					//解决长按“发送”按钮，导致键盘关闭的问题；
					ui.footerRight.addEventListener('touchmove', function(event) {
						if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							msgTextFocus();
							event.preventDefault();
						}
					});
					ui.footerRight.addEventListener('release', function(event) {
						if(ui.btnMsgType.classList.contains('mui-icon-paperplane')) {
							//showKeyboard();
							ui.boxMsgText.focus();
							setTimeout(function() {
								ui.boxMsgText.focus();
							}, 150);
							//							event.detail.gesture.preventDefault();
							send({
								sender: 'self',
								type: 'text',
								content: ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '<br/>')
							});
							ui.boxMsgText.value = '';
							$.trigger(ui.boxMsgText, 'input', null);
						} else if(ui.btnMsgType.classList.contains('mui-icon-mic')) {
							ui.btnMsgType.classList.add('mui-icon-compose');
							ui.btnMsgType.classList.remove('mui-icon-mic');
							ui.boxMsgText.style.display = 'none';
							ui.boxMsgSound.style.display = 'block';
							ui.boxMsgText.blur();
							document.body.focus();
						} else if(ui.btnMsgType.classList.contains('mui-icon-compose')) {
							ui.btnMsgType.classList.add('mui-icon-mic');
							ui.btnMsgType.classList.remove('mui-icon-compose');
							ui.boxMsgSound.style.display = 'none';
							ui.boxMsgText.style.display = 'block';
							//--
							//showKeyboard();
							ui.boxMsgText.focus();
							setTimeout(function() {
								ui.boxMsgText.focus();
							}, 150);
						}
					}, false);
					ui.boxMsgText.addEventListener('input', function(event) {
						ui.btnMsgType.classList[ui.boxMsgText.value == '' ? 'remove' : 'add']('mui-icon-paperplane');
						ui.btnMsgType.setAttribute("for", ui.boxMsgText.value == '' ? '' : 'msg-text');
						ui.h.innerText = ui.boxMsgText.value.replace(new RegExp('\n', 'gm'), '\n-') || '-';
						ui.footer.style.height = (ui.h.offsetHeight + footerPadding) + 'px';
						ui.content.style.paddingBottom = ui.footer.style.height;
					});
					ui.boxMsgText.addEventListener('tap', function(event) {
						ui.boxMsgText.focus();
						setTimeout(function() {
							ui.boxMsgText.focus();
						}, 0);
					}, false);
				});
			}(mui, document));
			/*定时器5秒刷一次 getChatDetail();*/
			window.setInterval(f, 5000);

			function f() {
				{
					console.log("刷新");
					var doctorID = localStorage.doctorID;
					var patientID = localStorage.patientID;
					mui.ajax(ajaxUrl + '/chat_getChatDetail.action?receiveId=P' + localStorage.patientId + '&sendId=D' + localStorage.DID, {
						dataType: 'json', //服务器返回json格式数据
						type: 'post', //HTTP请求类型
						/*async: false, //同步*/
						success: function(data) {
							if(data.length == 0) //数据为空时什么都不执行  
							{} else {
								/*提示音*/
								p = plus.audio.createPlayer("_www/js/qq.mp3");
								p.play(function() {
									
								}, function(e) {
									
								});
								/*end*/
								for(var n = 0; n < data.length; n++) {
									//							alert(data[n][2]);
									var info = data[n][2];
									document.getElementById("msg-list").innerHTML += "<div class=\"msg-item\" msg-type=\"text\" msg-content=\"" + info + "\">\n" +
										" 						<i><img src=\""+imgPath+localStorage.DImgPath+"\" class=\"msg-user mui-icon mui-icon-person\" /></i>\n" +
										" 					<div class=\"msg-content\">\n" +
										" 						<div class=\"msg-content-inner\">\n <p>"+new Date().Format("yyyy-MM-dd hh:mm:ss")+"</p>" +
										" 								" + info + "\n" +
										" 						</div>\n" +
										" 						<div class=\"msg-content-arrow\"></div>\n" +
										" 					</div>\n" +
										" 					<div class=\"mui-item-clear\"></div>\n" +
										" 				</div>";
									//						//						------------塞入本地-----------------------------------------------
									db.transaction(function(context4) {
										context4.executeSql('select max(id) mid from chatDetailTable', [],
											function(tx, result) {
												var id = (result.rows.item(0).mid) ? result.rows.item(0).mid : 0;
												console.log(id);
												context4.executeSql('INSERT INTO chatDetailTable (id,doctorId,rORl,messageContent,messageTime) VALUES (?,?,?,?,?)', [(id + 1), localStorage.DID, ' ', info, new Date().Format("yyyy-MM-dd hh:mm:ss")],
													function(tx, result) {
														console.log("成功插入数据");
													},
													function(tx, error) {
														console.log("插入数据失败");
													}
												);
											},
											function(tx, error) {
												console.log("查询最大Id值失败");
											}
										);
									})

								}
								var div = document.getElementById("msg-list");
								div.scrollTop = div.scrollHeight;
							}
						}
					})

				};
			}
			//时间格式化
			Date.prototype.Format = function(fmt) { //author: meizz 
						var o = {
							"M+": this.getMonth() + 1, //月份 
							"d+": this.getDate(), //日 
							"h+": this.getHours(), //小时 
							"m+": this.getMinutes(), //分 
							"s+": this.getSeconds(), //秒 
							"q+": Math.floor((this.getMonth() + 3) / 3), //季度 
							"S": this.getMilliseconds() //毫秒 
						};
						if(/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
						for(var k in o)
							if(new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
						return fmt;
					}
		</script>
		<!--lalala-->
		<script type="text/javascript" src="../../js/ServiceUrl.js"></script>
		<script type="text/javascript">
		</script>
	</body>

</html>